---
title: "BBSR Project Tracker"
subtitle: "Toggl -> README"
author: 
  name: "Michael Kaufman, PhD"
  orcid: 0000-0003-2441-5836
  email: michael.kaufman@cuanschutz.edu
  affiliation: 
    name: "University of Colorado Cancer Center"
    url: "https://medschool.cuanschutz.edu/colorado-cancer-center"
abstract:
  ""

editor: source
theme: cosmo
number-sections: true
link-citations: true
link-external-references: true

format:
  html:
    embed-resources: true
    self_contained: true
    highlight-style: pygments
    code-fold: true
    code-summary: "[code]"
    code-overflow: wrap
    toc: true
    toc-depth: 2
    toc-location: right  
    grid:
      sidebar-width: 200px
      body-width: 1800px
      margin-width: 100px
      gutter-width: 10px

execute:
  warning: false
  message: false
  fig.align: "center"

params:
  start_date: "2025-11-17"
  end_date: "2025-11-23"

---

## Environment setup

```{r setup}
library(tidyverse)
library(lubridate)
library(DT)
library(ggrepel)
```

## Load data

```{r}
# load the toggl csv
# grab toggl* .csv file from the project directory
toggl_file <- list.files(pattern = "Toggl.*\\.csv", full.names = TRUE)

if (length(toggl_file) == 0) {
  stop("No toggl CSV file found in the project directory.")
}

toggl_data <- read.csv(toggl_file, stringsAsFactors = FALSE)
```


### Filter and clean data

```{r}
# filter for date range, July 2025 to present
start_date <- as.Date(params$start_date)
end_date <- if (is.null(params$end_date) || params$end_date == "") {
  Sys.Date()
} else {
  as.Date(params$end_date)
}

# Convert Start.date to Date format and filter
filtered_data <- toggl_data %>%
  mutate(Start.date = as.Date(Start.date)) %>%
  filter(Start.date >= start_date & Start.date <= end_date)

# drop columns and reorder
filtered_data <- filtered_data %>%
  select(-User, -Email, -Client, -Billable, -Task) %>%
  select(Project, Tags, Description, Duration, everything())

# drop rows with empty Project column
filtered_data <- filtered_data %>%
  filter(Project != "")

```

```{r}
#| results: asis
# print the date range
cat("### Data from", format(start_date, "%Y-%m-%d"), "to", format(end_date, "%Y-%m-%d"), "\n")

# number of projects
num_projects <- n_distinct(filtered_data$Project)
cat("### Number of Projects:", num_projects, "\n")
```


```{r}
unique_projects <- unique(filtered_data$Project)

#sort alphabetically
unique_projects <- sort(unique_projects)

```

### Table of filtered data

```{r}
datatable(filtered_data)
```

## Overall stats

```{r}
#| results: asis

# calculate the number of possible work hours assuming M-F and 8 hour work days
total_days <- as.numeric(difftime(end_date, start_date, units = "days"))
all_days <- seq(start_date, end_date, by = "days")
workdays <- sum(!(wday(all_days) %in% c(1, 7)))  # 1 = Sunday, 7 = Saturday
possible_work_hours <- workdays * 8
cat("### Possible Work Hours (M-F, 8 hours/day):", possible_work_hours, "\n")
```
```{r}
# bar chart of total hours worked, vacation, and holidays

# calculate total logged hours
total_logged_hours <- filtered_data %>%
  mutate(duration_hours = as.numeric(hms(Duration)) / 3600) %>%
  summarise(total_hours = sum(duration_hours, na.rm = TRUE)) %>%
  pull(total_hours)
# calculate vacation hours (assuming "Vacation" is a task)
vacation_hours <- filtered_data %>%
  filter(Project == "Vacation") %>%
  mutate(duration_hours = as.numeric(hms(Duration)) / 3600) %>%
  summarise(total_hours = sum(duration_hours, na.rm = TRUE)) %>%
  pull(total_hours)
# calculate holiday hours (assuming "Holiday" is a task)
holiday_hours <- filtered_data %>%
  filter(Project == "Holiday") %>%
  mutate(duration_hours = as.numeric(hms(Duration)) / 3600) %>%
  summarise(total_hours = sum(duration_hours, na.rm = TRUE)) %>%
  pull(total_hours)
# calculate worked hours (total logged minus vacation and holiday)
annotated_work_hours <- total_logged_hours - vacation_hours - holiday_hours
# plot bar chart
hours_data <- data.frame(
  Category = c("Annotated Work Hours", "Vacation Hours", "Holiday Hours"),
  Hours = c(annotated_work_hours, vacation_hours, holiday_hours)
)

ggplot(hours_data, aes(x = Category, y = Hours, fill = Category)) +
  geom_bar(stat = "identity") +
  labs(title = "Total Hours Breakdown",
       x = "Category",
       y = "Hours") +
  theme_minimal()
```

### Project stats

```{r}
#> head(filtered_data)
# [1] User        Email       Client      Project     Task        Description
# [7] Billable    Start.date  Start.time  End.date    End.time    Duration   
# [13] Tags  

# plot number of projects
filtered_data %>%
  # Convert Duration from HH:MM:SS to numeric hours
  mutate(duration_hours = as.numeric(hms(Duration)) / 3600) %>%
  group_by(Project) %>%
  summarise(total_time = sum(duration_hours, na.rm = TRUE)) %>%
  arrange(desc(total_time)) %>%
  ggplot(aes(x = reorder(Project, total_time), y = total_time)) +
  geom_bar(stat = "identity") +
  coord_flip() +
  labs(title = "Total Time Spent on Projects",
       x = "Project",
       y = "Total Time (hours)") +
  theme_minimal()
```


```{r}
#| fig-width: 12
#| fig-height: 10
#total time as pie chart

pie_data <- filtered_data %>%
  mutate(duration_hours = as.numeric(hms(Duration)) / 3600) %>%
  group_by(Project) %>%
  summarise(total_time = sum(duration_hours, na.rm = TRUE)) %>%
  arrange(desc(total_time)) %>%
  mutate(
    percentage = total_time / sum(total_time) * 100,
    Project_label = paste0(Project, " (", round(percentage, 1), "%)")
  )

ggplot(pie_data, aes(x = "", y = total_time, fill = Project_label)) +
  geom_bar(stat = "identity", width = 1, color = "white", linewidth = 1) +
  coord_polar("y", start = 0) +
  scale_fill_brewer(palette = "Set3") +
  labs(title = "Percentage of Time Spent on Projects") +
  theme_void() +
  theme(plot.title = element_text(size = 18, face = "bold", hjust = 0.5, margin = margin(b = 20)),
        legend.title = element_blank(),
        legend.text = element_text(size = 12))
```

```{r}
filtered_data %>%
  mutate(duration_hours = as.numeric(hms(Duration)) / 3600,
         week = floor_date(Start.date, "week")) %>%
  group_by(week) %>%
  summarise(total_time = sum(duration_hours, na.rm = TRUE)) %>%
  ggplot(aes(x = week, y = total_time)) +
  geom_col() +
  labs(title = "Total Annotated Hours per Week",
       x = "Week",
       y = "Hours") +
  theme_minimal()
```

```{r}
#| fig-width: 14
#| fig-height: 6
filtered_data %>%
  mutate(duration_hours = as.numeric(hms(Duration)) / 3600,
         weekday = wday(Start.date, label = TRUE),
         hour = hour(hms(Start.time))) %>%
  group_by(weekday, hour) %>%
  summarise(total_time = sum(duration_hours, na.rm = TRUE), .groups = 'drop') %>%
  # Create a complete grid of all hours and weekdays
  complete(weekday = unique(weekday), hour = 0:23, fill = list(total_time = 0)) %>%
  ggplot(aes(x = weekday, y = hour, fill = total_time)) +
  geom_tile(color = "white", linewidth = 0.5) +
  scale_fill_gradient(low = "white", high = "#440154FF", na.value = "white") +
  scale_y_continuous(breaks = 0:23, expand = c(0, 0), trans = "reverse") +
  scale_x_discrete(position = "top") +
  labs(title = "Heatmap: Hours by Day & Hour",
       x = "Day of Week",
       y = "Hour of Day",
       fill = "Hours") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 0, hjust = 0.5))
```

## Project level stats

### Summary Table

```{r}
summary_table <- filtered_data %>%
  mutate(duration_hours = as.numeric(hms(Duration)) / 3600) %>%
  group_by(Project) %>%
  summarise(total_time = sum(duration_hours, na.rm = TRUE),
            entries = n()) %>%
  arrange(desc(total_time))
datatable(summary_table, 
          extensions = 'Buttons',
          options = list(
            pageLength = 50,
            scrollX = TRUE,
            dom = 'Bfrtip',
            buttons = list('copy', 'csv')
          ),
          rownames = FALSE) %>%
  formatRound(columns = "total_time", digits = 1)

```

### Monthly Summary by Project

```{r}
# Create monthly summary with projects as columns and months as rows
monthly_summary <- filtered_data %>%
  mutate(
    duration_hours = as.numeric(hms(Duration)) / 3600,
    month = floor_date(Start.date, "month")
  ) %>%
  group_by(month, Project) %>%
  summarise(total_hours = sum(duration_hours, na.rm = TRUE), .groups = 'drop') %>%
  pivot_wider(
    names_from = Project,
    values_from = total_hours,
    values_fill = 0
  ) %>%
  mutate(Month = format(month, "%Y-%m")) %>%
  select(Month, everything(), -month) %>%
  arrange(Month)

# Add a Total column
monthly_summary <- monthly_summary %>%
  mutate(Total = rowSums(select(., -Month), na.rm = TRUE))

# Calculate possible work hours for each month
monthly_work_hours <- filtered_data %>%
  mutate(month = floor_date(Start.date, "month")) %>%
  distinct(month) %>%
  arrange(month) %>%
  mutate(
    month_start = month,
    month_end = ceiling_date(month, "month") - days(1),
    # Ensure we don't go beyond the end_date
    month_end = pmin(month_end, end_date),
    # For the first month, start from start_date if it's not the 1st
    month_start = if_else(month == floor_date(start_date, "month"), start_date, month_start)
  ) %>%
  rowwise() %>%
  mutate(
    workdays = sum(!(wday(seq(month_start, month_end, by = "days")) %in% c(1, 7))),  # 1 = Sunday, 7 = Saturday
    possible_hours = workdays * 8
  ) %>%
  ungroup() %>%
  mutate(Month = format(month, "%Y-%m")) %>%
  select(Month, possible_hours)

# Add possible work hours and percent FTE to monthly summary
monthly_summary <- monthly_summary %>%
  left_join(monthly_work_hours, by = "Month") %>%
  mutate(`Percent FTE` = (Total / possible_hours) * 100) %>%
  select(Month, everything())

datatable(monthly_summary, 
          extensions = 'Buttons',
          options = list(
            pageLength = 25,
            scrollX = TRUE,
            dom = 'Bfrtip',
            buttons = list('copy', 'csv')
          ),
          rownames = FALSE) %>%
  formatRound(columns = 2:(ncol(monthly_summary)-2), digits = 1) %>%
  formatRound(columns = c("possible_hours", "Percent FTE"), digits = 1)
```


### Monthly FTE Breakdown

```{r}
#| results: asis
#| fig-width: 10
#| fig-height: 8
# For each month, create a pie chart showing FTE percentage per project

# First, create a consistent color palette for all projects
all_projects <- filtered_data %>%
  pull(Project) %>%
  unique() %>%
  sort()

# Add "Unannotated" to the list
all_projects <- c(all_projects, "Unannotated")

# Create a named vector of colors
library(RColorBrewer)
n_colors <- length(all_projects)
if (n_colors <= 12) {
  colors <- brewer.pal(max(3, n_colors), "Set3")
} else {
  colors <- colorRampPalette(brewer.pal(12, "Set3"))(n_colors)
}
project_colors <- setNames(colors, all_projects)

months <- filtered_data %>%
  mutate(month = floor_date(Start.date, "month")) %>%
  pull(month) %>%
  unique() %>%
  sort()

for (mo in months) {
  month_date <- as.Date(mo, origin = "1970-01-01")
  month_label <- format(month_date, "%B %Y")
  
  # Calculate possible work hours for this month
  month_start <- month_date
  month_end <- ceiling_date(month_date, "month") - days(1)
  month_end <- pmin(month_end, end_date)
  if (month_date == floor_date(start_date, "month")) {
    month_start <- start_date
  }
  
  workdays <- sum(!(wday(seq(month_start, month_end, by = "days")) %in% c(1, 7)))
  possible_hours <- workdays * 8
  
  # Calculate hours per project for this month
  month_data <- filtered_data %>%
    filter(floor_date(Start.date, "month") == month_date) %>%
    mutate(duration_hours = as.numeric(hms(Duration)) / 3600) %>%
    group_by(Project) %>%
    summarise(total_hours = sum(duration_hours, na.rm = TRUE), .groups = 'drop')
  
  # Calculate total annotated hours
  total_annotated <- sum(month_data$total_hours)
  
  # Add unannotated hours if there's a gap
  if (total_annotated < possible_hours) {
    unannotated <- possible_hours - total_annotated
    month_data <- bind_rows(
      month_data,
      data.frame(Project = "Unannotated", total_hours = unannotated)
    )
  }
  
  # Calculate FTE percentages
  month_data <- month_data %>%
    mutate(
      fte_percent = (total_hours / possible_hours) * 100,
      Project_label = paste0(Project, " (", round(fte_percent, 1), "% FTE)")
    ) %>%
    arrange(desc(total_hours))
  
  # Create a named vector of colors for this month's projects
  month_colors <- project_colors[month_data$Project]
  names(month_colors) <- month_data$Project_label
  
  # Create pie chart
  p <- ggplot(month_data, aes(x = "", y = total_hours, fill = Project_label)) +
    geom_bar(stat = "identity", width = 1, color = "white", linewidth = 1) +
    coord_polar("y", start = 0) +
    scale_fill_manual(values = month_colors) +
    labs(title = paste(month_label, "-", round(total_annotated, 1), "hours annotated of", possible_hours, "possible")) +
    theme_void() +
    theme(plot.title = element_text(size = 16, face = "bold", hjust = 0.5, margin = margin(b = 15)),
          legend.title = element_blank(),
          legend.text = element_text(size = 11))
  
  print(p)
  cat("\n\n")
}
```

### Per project breakdown

```{r}
#| results: asis
#| fig-width: 10
#| fig-height: 8
# for each project plot a pie chart of the project, description, tag columns as a percentage of project time spent

projects <- filtered_data %>%
  pull(Project) %>%
  unique() %>%
  sort()

for (proj in projects) {
  
  proj_data <- filtered_data %>%
    filter(Project == proj) %>%
    mutate(duration_hours = as.numeric(hms(Duration)) / 3600,
           Tags = ifelse(Tags == "" | is.na(Tags), "No Tag", Tags)) %>%
    group_by(Tags) %>%
    summarise(total_time = sum(duration_hours, na.rm = TRUE)) %>%
    arrange(desc(total_time)) %>%
    mutate(
      percentage = total_time / sum(total_time) * 100,
      Tags_label = paste0(Tags, " (", round(percentage, 1), "%)")
    )
  
  p <- ggplot(proj_data, aes(x = "", y = total_time, fill = Tags_label)) +
    geom_bar(stat = "identity", width = 1, color = "white", linewidth = 1) +
    coord_polar("y", start = 0) +
    scale_fill_brewer(palette = "Pastel1") +
    labs(title = paste(proj)) +
    theme_void() +
    theme(plot.title = element_text(size = 16, face = "bold", hjust = 0.5, margin = margin(b = 15)),
          legend.title = element_blank(),
          legend.text = element_text(size = 11))
  
  print(p)
  cat("\n\n")
}
```

## Session info
```{r}
sessionInfo()
```